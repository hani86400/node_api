name: Docker Image CI to GHCR (3)

on:
  push:
    branches: [ main123 ]
  workflow_dispatch:
    inputs:
      dockerfile_choice:
        type: choice
        description: "Select the Dockerfile to build"
        required: true
        options:
          - Dockerfile_busybox
          - Dockerfile_alpine
          - Dockerfile_bookworm
          - Dockerfile_distroless
          - Dockerfile_multi_stage
          - Dockerfile_node_api
          - Dockerfile_wxyz          

env:
  RESEND_API_URL: ${{ vars.RESEND_API_URL }}
  RESEND_API_H_AUTH: ${{ secrets.RESEND_API_H_AUTH }}
  EMAIL_FROM: ${{ secrets.COC_EMAIL }}
  EMAIL_TO: ${{ secrets.ADMIN_EMAIL }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Set Environment Variables
        run: |
          TAG_VALUE=$(date +%s)
          TAG_VALUE="$(date +%Y%m%d-%H%M%S)-${{ github.event.inputs.dockerfile_choice }}"          
          echo "CURRENT_TAG=$TAG_VALUE" >> $GITHUB_ENV
          echo "DOCKER_FILE=${{ github.event.inputs.dockerfile_choice }}" >> $GITHUB_ENV
          echo "The tag will be $TAG_VALUE"
          echo "Using Dockerfile: ${{ github.event.inputs.dockerfile_choice }}"
          CURRENT_SECOND=$(date +%s)
          echo "CURRENT_SECOND=$CURRENT_SECOND" >> $GITHUB_ENV
          

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        id: buildpush
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          file: ./${{ env.DOCKER_FILE }}
          tags: ghcr.io/${{ github.repository }}:${{ env.CURRENT_TAG }}

      - name: Log Docker Pull Command
        run: |
          echo "Successfully pushed image. To pull, run:"
          echo "docker pull ghcr.io/${{ github.repository }}:${{ env.CURRENT_TAG }}"

      # --- Success Notification ---
      - name: Send Success Email
        if: success()
        run: |
          IMAGE_URL="ghcr.io/${{ github.repository }}:${{ env.CURRENT_TAG }}"
          MESSAGE="<h3>✅ Docker Image Build Complete</h3>
          <p><b>Repository:</b> ${{ github.repository }}</p>
          <p><b>Tag:</b> ${{ env.CURRENT_TAG }}</p>
          <p><b>Dockerfile:</b> ${{ env.DOCKER_FILE }}</p>
          <p><b>Pull command:</b><br>
          <code>docker pull $IMAGE_URL</code></p>
          <p><b>Workflow Run:</b> <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs</a></p>"

          PAYLOAD=$(jq -n \
            --arg from "$EMAIL_FROM" \
            --arg to "$EMAIL_TO" \
            --arg subject "Docker Image Build Success ✅ ${{ env.CURRENT_SECOND }}" \
            --arg html "$MESSAGE" \
            '{from:$from,to:$to,subject:$subject,html:$html}')

          curl -s -X POST "$RESEND_API_URL" \
            -H "$RESEND_API_H_AUTH" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"

      # --- Failure Notification ---
      - name: Send Failure Email
        if: failure()
        run: |
          MESSAGE="<h3>❌ Docker Image Build Failed</h3>
          <p><b>Repository:</b> ${{ github.repository }}</p>
          <p><b>Branch:</b> ${{ github.ref_name }}</p>
          <p><b>Dockerfile:</b> ${{ env.DOCKER_FILE }}</p>
          <p><b>Commit:</b> ${{ github.sha }}</p>
          <p><b>Workflow Run:</b> <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs</a></p>"

          PAYLOAD=$(jq -n \
            --arg from "$EMAIL_FROM" \
            --arg to "$EMAIL_TO" \
            --arg subject "Docker Image Build Failed ❌ ${{ env.CURRENT_SECOND }}" \
            --arg html "$MESSAGE" \
            '{from:$from,to:$to,subject:$subject,html:$html}')

          curl -s -X POST "$RESEND_API_URL" \
            -H "$RESEND_API_H_AUTH" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"
